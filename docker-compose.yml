services:
  # TRT Engine Builder - runs once to build the engine
  trt-builder:
    build:
      context: .
      dockerfile: Dockerfile  # Same image as miner for consistency
    image: dippy-studio-bittensor-miner:latest
    gpus: "all"
    entrypoint: ["/workspace/scripts/trt_build_in_container.sh"]
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # Build configuration (match your production settings)
      - TRT_BUILD_SAFE=0  # Set to 1 only if you need safe export mode
      - USE_FLASH_ATTENTION=1  # Enable for better performance
      - XFORMERS_DISABLED=0
      - MODEL_PATH=black-forest-labs/FLUX.1-dev
      - TRT_CACHE_DIR=/trt-cache
    volumes:
      - ./trt-cache:/trt-cache
      - ~/.cache/huggingface:/root/.cache/huggingface
      - ./scripts:/workspace/scripts:ro
    profiles: ["build"]  # Doesn't start with regular docker compose up

  miner:
    build:
      context: .
      dockerfile: Dockerfile
    image: dippy-studio-bittensor-miner:latest
    container_name: dippy-studio-bittensor-miner
    ports:
      - "8091:8091"
    gpus: "all"
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

      # Miner configuration
      - ENABLE_TRAINING=${ENABLE_TRAINING:-true}
      - ENABLE_INFERENCE=${ENABLE_INFERENCE:-true}
      - MODEL_PATH=${MODEL_PATH:-black-forest-labs/FLUX.1-dev}
      - LORA_PATH=${LORA_PATH:-}
      - OUTPUT_DIR=${OUTPUT_DIR:-/app/output}
      - MINER_SERVER_PORT=${MINER_SERVER_PORT:-8091}
      - MINER_SERVER_HOST=${MINER_SERVER_HOST:-0.0.0.0}
      - SERVICE_URL=${SERVICE_URL:-}  # Set to your public URL in production
      - TRT_ENGINE_PATH=/trt-cache/NVIDIA_H100_PCIe_cu12.4_trt10.5.0_fp16/transformer.plan

      # Runtime settings (no building in miner)
      - TRT_BUILD_SAFE=0
      - CUDA_FORCE_PTX_JIT=0  # Explicitly disable to prevent runtime errors
      - FAIL_ON_TRT_BUILD_ERROR=1  # Fail fast if engine missing
    volumes:
      - ./datasets:/app/datasets
      - ./output:/app/output
      - ./output:/workspace/output  # Training saves here (working directory)
      - ./config:/app/config
      - ./models:/app/models
      - ./trt-cache:/trt-cache
      - ~/.cache/huggingface:/root/.cache/huggingface
    restart: unless-stopped